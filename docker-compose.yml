# ─────────────────────────────────────────────────────────────
#  BielsaSys — Docker Compose con PostgreSQL
# ─────────────────────────────────────────────────────────────

version: '3.9'

services:
  # ── Base de datos PostgreSQL ────────────────────────────────
  db:
    image: postgres:15-alpine
    container_name: bielsasys_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: bielsauser
      POSTGRES_PASSWORD: bielsapassword
      POSTGRES_DB: bielsasys
    volumes:
      - bielsadata:/var/lib/postgresql/data
    networks:
      - bielsanet

  # ── Aplicación Node.js ──────────────────────────────────────
  app:
    build: .
    container_name: bielsasys_app
    restart: unless-stopped
    environment:
      - PORT=3000
      - NODE_ENV=production
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS:-bielsasys2025}
      - JWT_SECRET=${JWT_SECRET:-bielsasys_jwt_secret_cambia_esto}
      # Variables de conexión a PostgreSQL
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=bielsauser
      - DB_PASS=bielsapassword
      - DB_NAME=bielsasys
    volumes:
      - ./logs:/app/logs
    depends_on:
      - db
    networks:
      - bielsanet
    expose:
      - "3000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ── Nginx Reverse Proxy ─────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: bielsasys_nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - app
    networks:
      - bielsanet

networks:
  bielsanet:
    driver: bridge

volumes:
  bielsadata: